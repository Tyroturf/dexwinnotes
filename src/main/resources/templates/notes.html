<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dexwin Notes</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: system-ui, sans-serif;
            background: #020617;
            color: #e5e7eb;
        }
        header {
            padding: 0.9rem 1.1rem;
            border-bottom: 1px solid #1f2937;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #020617;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .logo {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        input, select {
            padding: 0.4rem 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid #1f2937;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.85rem;
        }
        main {
            padding: 1rem 1.25rem 1.5rem;
            max-width: 900px;
            margin: 0 auto;
        }
        .toolbar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }
        button {
            border: none;
            border-radius: 999px;
            padding: 0.45rem 0.9rem;
            font-size: 0.85rem;
            cursor: pointer;
            background: #1f2937;
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        button.primary {
            background: #2563eb;
            color: white;
        }
        button.danger {
            background: #b91c1c;
        }
        button:disabled {
            opacity: 0.7;
            cursor: default;
        }
        .note-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        .note {
            border-radius: 0.75rem;
            padding: 0.75rem 0.9rem;
            background: #020617;
            border: 1px solid #1f2937;
        }
        .note.deleted {
            opacity: 0.5;
            border-style: dashed;
        }
        .note-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            word-wrap: break-word;
        }
        .note-tags {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 0.25rem;
        }
        /* ðŸ”¹ NEW: content snippet styling */
        .note-content {
            font-size: 0.8rem;
            color: #d1d5db;
            margin-bottom: 0.35rem;
            white-space: pre-line;      /* respect line breaks */
            max-height: 4.5em;          /* ~3 lines */
            overflow: hidden;
        }
        .note-meta {
            font-size: 0.7rem;
            color: #6b7280;
        }
        .note-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .pagination {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            flex-wrap: wrap;
        }
        .pagination button {
            padding-inline: 0.75rem;
        }
        .badge {
            display: inline-block;
            padding: 0.05rem 0.4rem;
            border-radius: 999px;
            background: #111827;
            margin-right: 0.25rem;
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }
        .modal {
            background: #020617;
            border-radius: 1rem;
            padding: 1rem 1.25rem;
            width: 420px;
            max-width: 100%;
            max-height: 90vh;
            overflow: auto;
            border: 1px solid #1f2937;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            resize: vertical;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #1f2937;
            background: #020617;
            color: #e5e7eb;
            font-size: 0.85rem;
        }
        .field {
            margin-top: 0.6rem;
        }
        .field label {
            display: block;
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 0.15rem;
        }
        .error {
            color: #fca5a5;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        .status {
            font-size: 0.82rem;
            min-height: 1.2em;
            margin-bottom: 0.6rem;
        }
        .status.error {
            color: #fca5a5;
            font-weight: 500;
        }
        .status.success {
            color: #bbf7d0;
            font-weight: 500;
        }

        @media (max-width: 640px) {
            header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            .controls {
                width: 100%;
                justify-content: flex-start;
            }
            .controls button {
                flex: 1;
                text-align: center;
            }
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .toolbar > * {
                width: 100%;
            }
            main {
                padding: 0.75rem 1rem 1.25rem;
            }
        }

        @media (max-width: 400px) {
            header {
                padding-inline: 0.75rem;
            }
            main {
                padding-inline: 0.75rem;
            }
            .modal {
                padding-inline: 0.9rem;
            }
        }
    </style>
</head>
<body>
<header>
    <div class="logo">Dexwin Notes</div>
    <div class="controls">
        <button class="primary" onclick="openModal()">+ New note</button>
        <button onclick="logout()">Logout</button>
    </div>
</header>
<main>
    <div class="status" id="status"></div>

    <div class="toolbar">
        <input id="search" placeholder="Search title/content..." style="flex:1; min-width:140px;"/>
        <input id="tagsFilter" placeholder="Tags (comma separated)" style="min-width:140px;"/>
        <select id="sortBy">
            <option value="updatedAt">Updated</option>
            <option value="createdAt">Created</option>
            <option value="title">Title</option>
        </select>
        <select id="direction">
            <option value="DESC">Desc</option>
            <option value="ASC">Asc</option>
        </select>
        <button class="primary" onclick="loadNotes(0)">Apply</button>
    </div>

    <div class="note-list" id="noteList"></div>
    <div class="pagination" id="pagination"></div>
</main>

<div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
        <h2 id="modalTitle">New note</h2>
        <div class="field">
            <label>Title</label>
            <input id="noteTitle"/>
            <div class="error" id="errorTitle"></div>
        </div>
        <div class="field">
            <label>Content</label>
            <textarea id="noteContent"></textarea>
            <div class="error" id="errorContent"></div>
        </div>
        <div class="field">
            <label>Tags (comma separated)</label>
            <input id="noteTags"/>
        </div>
        <div style="margin-top:0.75rem; display:flex; justify-content:flex-end; gap:0.5rem; flex-wrap:wrap;">
            <button onclick="closeModal()">Cancel</button>
            <button class="primary" onclick="saveNote()">Save</button>
        </div>
    </div>
</div>

<script>
    let currentPage = 0;
    let editingNote = null;

    const statusBox = document.getElementById("status");

    function setStatus(message, isError) {
        if (!statusBox) return;
        statusBox.textContent = message || "";
        statusBox.classList.remove("error", "success");
        if (!message) return;
        statusBox.classList.add(isError ? "error" : "success");
    }

    function token() {
        return localStorage.getItem("notes_token");
    }

    function authHeaders() {
        return {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token()
        };
    }

    function ensureAuth() {
        if (!token()) {
            window.location.href = "/login";
        }
    }

    function logout() {
        localStorage.removeItem("notes_token");
        window.location.href = "/login";
    }

    function openModal(note) {
        editingNote = note || null;
        document.getElementById("noteTitle").value = note ? note.title : "";
        document.getElementById("noteContent").value = note ? note.content : "";
        document.getElementById("noteTags").value = note ? (note.tags || "") : "";
        document.getElementById("errorTitle").textContent = "";
        document.getElementById("errorContent").textContent = "";
        document.getElementById("modalTitle").textContent = note ? "Edit note" : "New note";
        document.getElementById("modalBackdrop").style.display = "flex";
        document.getElementById("noteTitle").focus();
    }

    function closeModal() {
        document.getElementById("modalBackdrop").style.display = "none";
        editingNote = null;
    }

    // ðŸ”¹ helper to safely render content
    function escapeHtml(str) {
        if (!str) return "";
        return str
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    async function loadNotes(page) {
        ensureAuth();
        currentPage = page;
        const q = document.getElementById("search").value;
        const tags = document.getElementById("tagsFilter").value;
        const sortBy = document.getElementById("sortBy").value;
        const direction = document.getElementById("direction").value;

        const params = new URLSearchParams({
            page,
            size: 5,
            sortBy,
            direction
        });
        if (q) params.append("query", q);
        if (tags) params.append("tags", tags);

        try {
            const res = await fetch("/api/notes?" + params.toString(), {
                headers: { "Authorization": "Bearer " + token() }
            });
            if (res.status === 401) {
                logout();
                return;
            }
            const data = await res.json();
            renderNotes(data);
            setStatus("", false);
        } catch (e) {
            console.error(e);
            setStatus("Could not load notes. Please try again.", true);
        }
    }

    function renderNotes(data) {
        const list = document.getElementById("noteList");
        list.innerHTML = "";
        (data.content || []).forEach(n => {
            const div = document.createElement("div");
            div.className = "note" + (n.deletedAt ? " deleted" : "");

            const tagsHtml = (n.tags || "").split(",")
                .filter(Boolean)
                .map(t => "<span class='badge'>" + escapeHtml(t.trim()) + "</span>")
                .join("");

            // ðŸ”¹ build a safe snippet of content
            let rawContent = n.content || "";
            let shortContent = rawContent.length > 260
                ? rawContent.slice(0, 260) + "â€¦"
                : rawContent;
            const snippetHtml = escapeHtml(shortContent);

            div.innerHTML = `
                <div class="note-title">${escapeHtml(n.title || "")}</div>
                <div class="note-tags">${tagsHtml}</div>
                <div class="note-content">${snippetHtml}</div>
                <div class="note-meta">
                    Updated: ${escapeHtml(n.updatedAt || "")} ${n.deletedAt ? " â€¢ deleted" : ""}
                </div>
                <div class="note-actions">
                    <button class="edit-btn">Edit</button>
                    ${
                        n.deletedAt
                            ? "<button class='restore-btn'>Restore</button>"
                            : "<button class='danger delete-btn'>Delete</button>"
                    }
                </div>
            `;

            const editBtn = div.querySelector(".edit-btn");
            editBtn.onclick = () => openModal(n);

            const delBtn = div.querySelector(".delete-btn");
            if (delBtn) {
                delBtn.onclick = () => deleteNote(n.id);
            }

            const restoreBtn = div.querySelector(".restore-btn");
            if (restoreBtn) {
                restoreBtn.onclick = () => restoreNote(n.id);
            }

            list.appendChild(div);
        });

        const p = document.getElementById("pagination");
        p.innerHTML = "";
        const info = document.createElement("span");
        info.textContent = `Page ${data.page + 1} of ${data.totalPages || 1}`;
        const prev = document.createElement("button");
        prev.textContent = "Prev";
        prev.disabled = data.page === 0;
        prev.onclick = () => loadNotes(data.page - 1);
        const next = document.createElement("button");
        next.textContent = "Next";
        next.disabled = data.page + 1 >= data.totalPages;
        next.onclick = () => loadNotes(data.page + 1);
        p.appendChild(prev);
        p.appendChild(next);
        p.appendChild(info);
    }

    async function saveNote() {
        ensureAuth();
        const title = document.getElementById("noteTitle").value.trim();
        const content = document.getElementById("noteContent").value.trim();
        const tags = document.getElementById("noteTags").value.trim();
        document.getElementById("errorTitle").textContent = "";
        document.getElementById("errorContent").textContent = "";

        if (!title) {
            document.getElementById("errorTitle").textContent = "Title is required.";
            return;
        }
        if (!content) {
            document.getElementById("errorContent").textContent = "Content is required.";
            return;
        }

        const payload = { title, content, tags };
        if (editingNote && editingNote.version != null) {
            payload.version = editingNote.version;
        }

        const url = editingNote ? "/api/notes/" + editingNote.id : "/api/notes";
        const method = editingNote ? "PUT" : "POST";

        try {
            const res = await fetch(url, {
                method,
                headers: authHeaders(),
                body: JSON.stringify(payload)
            });
            if (res.status === 409) {
                setStatus("Note was updated elsewhere. Refresh list and try again.", true);
                return;
            }
            if (!res.ok) {
                let data = {};
                let text = "";
                try {
                    text = await res.text();
                    data = JSON.parse(text);
                } catch (_) {}
                console.error(data || text);
                const msg = data.message || data.detail || text;
                setStatus(msg || "Could not save note. Please try again.", true);
                return;
            }
            closeModal();
            setStatus(editingNote ? "Note updated." : "Note created.", false);
            loadNotes(currentPage);
        } catch (e) {
            console.error(e);
            setStatus("Could not save note. Please try again.", true);
        }
    }

    async function deleteNote(id) {
        ensureAuth();
        try {
            const res = await fetch("/api/notes/" + id + "/delete", {
                method: "POST",
                headers: { "Authorization": "Bearer " + token() }
            });
            if (!res.ok) {
                setStatus("Could not delete note.", true);
                return;
            }
            setStatus("Note deleted.", false);
            loadNotes(currentPage);
        } catch (e) {
            console.error(e);
            setStatus("Could not delete note.", true);
        }
    }

    async function restoreNote(id) {
        ensureAuth();
        try {
            const res = await fetch("/api/notes/" + id + "/restore", {
                method: "POST",
                headers: { "Authorization": "Bearer " + token() }
            });
            if (!res.ok) {
                setStatus("Could not restore note.", true);
                return;
            }
            setStatus("Note restored.", false);
            loadNotes(currentPage);
        } catch (e) {
            console.error(e);
            setStatus("Could not restore note.", true);
        }
    }

    document.getElementById("search").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            loadNotes(0);
        }
    });
    document.getElementById("tagsFilter").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            loadNotes(0);
        }
    });

    document.addEventListener("keydown", function (e) {
        const modalVisible = document.getElementById("modalBackdrop").style.display === "flex";
        if (!modalVisible) return;

        if (e.key === "Enter") {
            const active = document.activeElement;
            if (active && (active.id === "noteTitle" || active.id === "noteContent" || active.id === "noteTags")) {
                e.preventDefault();
                saveNote();
            }
        }
    });

    ensureAuth();
    loadNotes(0);
</script>
</body>
</html>
